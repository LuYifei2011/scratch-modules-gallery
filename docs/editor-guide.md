# 模块编辑器使用指南

## 概述

模块编辑器是一个集成在开发服务器中的可视化工具，允许你在浏览器中直接创建、编辑和管理模块，无需手动操作文件系统。

## 访问编辑器

启动开发服务器后，在浏览器中访问：

```plain
http://localhost:8800/__dev/editor/
```

**注意：** 编辑器仅在开发模式下可用，不会影响生产构建。

## 功能特性

### 1. 模块管理

#### 创建新模块

- 点击左侧边栏底部的 **"+ 新建模块"** 按钮
- 填写模块信息：
  - **模块 ID**：唯一标识符，只允许小写字母、数字和短横线（例如：`my-awesome-module`）
  - **名称**：模块的显示名称
  - **描述**：简短描述模块功能
  - **标签**：用逗号分隔的标签（可选）
- 点击 **"创建"** 按钮

#### 编辑模块元信息

1. 在左侧边栏点击选择一个模块
2. 在 **"元信息"** 标签页中编辑字段：
   - 名称
   - 描述
   - 标签
   - 贡献者（格式：`gh/用户名` 表示 GitHub，`sc/用户名` 表示 Scratch，或直接输入名字）
3. 点击 **"保存"** 按钮

#### 删除模块

1. 选择要删除的模块
2. 在 **"元信息"** 标签页底部点击 **"删除模块"** 按钮
3. 确认删除操作

**警告：** 删除操作无法撤销，但如果启用了 Git 版本控制，可以通过 Git 恢复。

### 2. 脚本编辑

#### 添加新脚本

1. 切换到 **"脚本"** 标签页
2. 点击 **"+ 添加脚本"** 按钮
3. 输入脚本文件名（必须以 `.txt` 结尾）
   - 推荐格式：`01-main.txt`、`02-helper.txt` 等
   - 文件名前的数字用于排序

#### 编辑脚本内容

1. 在左侧脚本列表中点击选择一个脚本文件
2. 在右侧编辑器中修改内容
3. 点击 **"保存"** 按钮

#### 重命名脚本

1. 选择要重命名的脚本
2. 修改顶部的文件名输入框
3. 点击 **"保存"** 按钮

#### 删除脚本

1. 选择要删除的脚本
2. 点击 **"删除"** 按钮
3. 确认删除操作

**注意：** 每个模块至少需要保留一个脚本文件。

### 3. 翻译管理

#### 添加/编辑翻译

1. 切换到 **"翻译"** 标签页
2. 从下拉菜单中选择语言（en、zh-cn、zh-tw）
3. 填写翻译字段：
   - **名称**：模块名称的翻译
   - **描述**：描述的翻译
   - **标签**：标签的翻译（用逗号分隔）
   - **其他翻译字段**：JSON 格式，支持以下字段：
     - `variables`：变量名映射
     - `lists`：列表名映射
     - `events`：事件名映射
     - `scriptTitles`：脚本标题映射
     - `procedures`：自定义块 pattern 映射
     - `procedureParams`：自定义块参数名映射
4. 点击 **"保存翻译"** 按钮

#### JSON 格式示例

```json
{
  "variables": {
    "counter": "计数器",
    "result": "结果"
  },
  "procedures": {
    "My Block _": "我的积木 _"
  },
  "procedureParams": {
    "value": "数值"
  }
}
```

#### 删除翻译

1. 选择要删除的语言
2. 点击 **"删除翻译"** 按钮
3. 确认删除操作

### 4. 资源管理

#### 上传 Demo 项目

1. 切换到 **"资源"** 标签页
2. 在 **"Demo 项目"** 区域点击 **"上传 Demo"** 按钮
3. 选择 `.sb3` 文件（最大 10MB）
4. 等待上传完成

#### 删除 Demo 项目

- 如果已上传 Demo，点击 **"删除"** 按钮

#### 上传其他资源文件

1. 在 **"资源文件"** 区域点击 **"上传资源"** 按钮
2. 选择文件（支持：.png, .jpg, .jpeg, .gif, .svg, .pdf，最大 5MB）
3. 等待上传完成

#### 删除资源文件

- 在资源列表中找到对应文件，点击 **"删除"** 按钮

## 构建状态监控

编辑器右下角显示实时构建状态：

- **就绪**：无构建活动
- **正在构建...**：构建进行中（蓝色背景）
- **构建完成**：显示构建耗时
- **构建失败**：红色背景，表示出错
- **连接已断开**：与服务器失去连接

保存任何更改后，编辑器会自动触发构建，并实时显示构建进度。

## 自动刷新

编辑器使用 SSE（Server-Sent Events）与开发服务器保持连接：

- 文件更改后自动触发构建
- 构建完成后通知编辑器更新状态
- 无需手动刷新页面

## 搜索模块

在左侧边栏顶部的搜索框中输入关键词，可以实时过滤模块列表：

- 支持按模块 ID 搜索
- 支持按模块名称搜索
- 支持按描述内容搜索

## 注意事项

### 文件命名规则

- **模块 ID**：只允许小写字母、数字和短横线
- **脚本文件名**：必须以 `.txt` 结尾，推荐使用数字前缀（如 `01-`、`02-`）
- **避免使用特殊字符**：不要在文件名中使用空格、下划线以外的特殊字符

### 数据安全

- 所有更改直接写入文件系统（`content/modules/`）
- 建议使用 Git 版本控制来跟踪更改
- 删除操作无法在编辑器中撤销，但可通过 Git 恢复

### 并发编辑

- 编辑器不支持多人同时编辑同一模块
- 如果多个编辑器实例同时运行，可能导致数据冲突
- 建议一次只运行一个编辑器实例

### 性能优化

- 脚本内容自动规范化为 UTF-8 编码和 LF 行尾
- JSON 文件自动格式化（2 空格缩进）
- 小于 256KB 的文件使用缓存加速访问

## 键盘快捷键

目前编辑器未实现键盘快捷键，计划在后续版本中添加：

- `Ctrl+S`：保存当前内容
- `Ctrl+N`：创建新模块/脚本
- `Ctrl+F`：聚焦搜索框

## 故障排除

### 编辑器无法加载

- 确认开发服务器正在运行
- 检查浏览器控制台是否有错误信息
- 尝试刷新页面

### 保存失败

- 检查文件权限（确保有写入权限）
- 验证输入内容格式是否正确
- 查看浏览器控制台和服务器日志

### 构建卡住

- 检查服务器终端是否有错误
- 尝试手动运行 `npm run build` 诊断问题
- 重启开发服务器

### 上传文件失败

- 检查文件大小（Demo < 10MB，资源 < 5MB）
- 验证文件类型是否受支持
- 确认网络连接稳定

## API 端点参考

编辑器使用以下 RESTful API 端点（仅开发模式）：

### 模块管理

- `GET /api/modules` - 获取所有模块列表
- `GET /api/modules/:id` - 获取单个模块详情
- `POST /api/modules` - 创建新模块
- `PUT /api/modules/:id/meta` - 更新模块元信息
- `DELETE /api/modules/:id` - 删除模块

### 脚本管理

- `GET /api/modules/:id/scripts` - 获取脚本列表
- `POST /api/modules/:id/scripts` - 创建新脚本
- `PUT /api/modules/:id/scripts/:filename` - 更新脚本
- `DELETE /api/modules/:id/scripts/:filename` - 删除脚本

### 翻译管理

- `GET /api/modules/:id/i18n/:locale` - 获取翻译
- `PUT /api/modules/:id/i18n/:locale` - 更新翻译
- `DELETE /api/modules/:id/i18n/:locale` - 删除翻译

### 资源管理

- `POST /api/modules/:id/demo` - 上传 Demo
- `DELETE /api/modules/:id/demo` - 删除 Demo
- `POST /api/modules/:id/assets` - 上传资源
- `DELETE /api/modules/:id/assets/:filename` - 删除资源

### 构建状态

- `GET /api/build/status` - 获取构建状态

## 未来增强计划

- [ ] 集成 CodeMirror 6 提供代码高亮和自动补全
- [ ] 实时脚本预览（scratchblocks 渲染）
- [ ] 拖拽排序脚本文件
- [ ] 批量翻译导入/导出
- [ ] 模块模板功能
- [ ] 撤销/重做操作
- [ ] 键盘快捷键支持
- [ ] 暗色主题
- [ ] 多人协作编辑（WebSocket）

## 贡献指南

如需改进编辑器功能，请参考：

- 后端 API：`scripts/lib/editor-api.js`
- 前端界面：`public/__dev/editor/`
- 开发服务器：`scripts/dev-server.js`

欢迎提交 Pull Request！
