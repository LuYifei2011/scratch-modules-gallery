{% import "partials/icons.njk" as icons %}
<!DOCTYPE html>
<html lang="{{ config.language }}">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>
            {% block title %}{{ config.siteName }}{% endblock %}
        </title>
        <meta name="description"
              content="{% block meta_description %}{{ config.description }}{% endblock %}" />
        {% block meta_keywords %}<meta name="keywords" content="{{ config.keywords or '' }}" />{% endblock %}
        <meta name="darkreader-lock" content="true" />
        <meta name="theme-color"
              content="#1747a6"
              media="(prefers-color-scheme: light)">
        <meta name="theme-color"
              content="#0d1e33"
              media="(prefers-color-scheme: dark)">
        <link rel="canonical" href="{{ config.baseUrl }}{{ canonical or '/' }}" />
        {% if locales and locale and pagePath %}
            {% for loc in locales %}
                <link rel="alternate"
                      href="{{ config.baseUrl }}{{ '/' + loc + pagePath }}"
                      hreflang="{{ (langTags and langTags[loc]) or loc }}" />
            {% endfor %}
            <link rel="alternate"
                  href="{{ config.baseUrl }}{{ '/' + locale + pagePath }}"
                  hreflang="x-default" />
        {% endif %}
        <link rel="stylesheet" href="{{ assetBase }}/style.css" />
        <link rel="stylesheet" href="{{ assetBase }}/components.css" />
        {% block head_extra %}{% endblock %}
    </head>
    <body>
        <header>
            <div class="site-title">
                <a href="{{ pageBase or basePath }}/">{{ config.siteName }}</a>
            </div>
            <nav class="top-actions">
                {% if IS_DEV and buildIssuesSummary and buildIssuesSummary.total > 0 %}
                    <div id="__issues-banner"
                         class="issue-banner {% if buildIssuesSummary.errors>0 %}issue-banner-error{% else %}issue-banner-warning{% endif %}"
                         style="padding:var(--space-xs) var(--space-md);
                                font-size:var(--font-size-xs);
                                margin:0">
                        <strong style="font-weight:var(--font-weight-semibold);">
                            {% if buildIssuesSummary.errors>0 %}
                                {{ t.issues.bannerErrors }}
                            {% else %}
                                {{ t.issues.bannerWarnings }}
                            {% endif %}
                        </strong>
                        <span style="opacity:.8;">{{ t.issues.bannerCounts | replace('{errors}', buildIssuesSummary.errors) | replace('{warnings}', buildIssuesSummary.warnings) }}</span>
                        <a href="{{ pageBase }}/issues/"
                           style="color:var(--color-primary);
                                  margin-left:var(--space-md)">{{ t.issues.bannerView }}</a>
                        <button id="__issues-banner-close"
                                style="margin-left:var(--space-sm);
                                       cursor:pointer">×</button>
                    </div>
                    <script>
                            (function () {
                                var b = document.getElementById('__issues-banner');
                                var c = document.getElementById('__issues-banner-close');
                                if (c) {
                                    c.addEventListener('click', function () {
                                        if (b) 
                                            b.remove();
                                        
                                    });
                                }
                            })();
                    </script>
                {% endif %}
                {% if config.repoUrl %}
                    <a class="gh-btn"
                       href="{{ config.repoUrl }}"
                       target="_blank"
                       rel="noopener"
                       aria-label="{{ t.base.githubAriaLabel }}">
                        {{ icons.iconGitHub() }}
                        <span class="label">GitHub</span>
                    </a>
                {% endif %}
                <div class="lang-switch">
                    <button id="lang-btn"
                            class="lang-btn"
                            aria-label="{{ t.base.languageSwitchTitle }}"
                            aria-expanded="false">
                        {{ icons.iconLanguage() }}
                        <span class="lang-current">{{ i18n[locale].meta.languageName or locale }}</span>
                        {{ icons.iconChevronDown(16, 16, "lang-arrow") }}
                    </button>
                    <div id="lang-menu" class="lang-menu" hidden>
                        {% for loc in locales %}
                            <button class="lang-option {% if locale==loc %}lang-option-active{% endif %}"
                                    data-locale="{{ loc }}">
                                {{ i18n[loc].meta.languageName or loc }}
                            </button>
                        {% endfor %}
                        <div class="lang-divider"></div>
                        <label class="lang-remember">
                            <input type="checkbox" id="lang-remember-checkbox" />
                            <span>{{ t.base.rememberLanguage }}</span>
                            <span class="lang-remember-tooltip" title="{{ t.base.rememberLanguageTooltip }}">
                                {{ icons.iconCircleQuestionMark(14, 14, "icon-tooltip") }}
                            </span>
                        </label>
                    </div>
                </div>
            </nav>
        </header>
        <main>
            {% block content %}{% endblock %}
        </main>
        <footer>
            {% if modules is defined and not module %}
                <p class="site-module-count">{{ t.base.moduleCount | replace('{count}', modules | length) }}</p>
            {% endif %}
            <a class="nav-link" href="{{ pageBase }}/about/">{{ t.base.aboutLink }}</a>
            <p>
                &copy; 2025-2026
                <a href="https://github.com/LuYifei2011" target="_blank">Lu Yifei</a>
            </p>
        </footer>
        <script>
                window.__I18N = {{ (t or {}) | dump | safe }};
                window.IS_DEV = {{ IS_DEV and true or false }};
                window.PAGE_BASE = '{{ pageBase or assetBase }}';
                window.ASSET_BASE = '{{ assetBase }}';
                window.LOCALES = {{ locales | dump | safe }};
                window.CURRENT_LOCALE = '{{ locale }}';
                window.LOCALE_NAMES = {{ i18n | dump | safe }};
                // 检查是否需要重定向到偏好语言
                (function () {
                    try {
                        var rememberLang = localStorage.getItem('remember-language') === 'true';
                        var preferredLocale = localStorage.getItem('preferred-locale');
                        var currentLocale = '{{ locale }}';
                        if (rememberLang && preferredLocale && preferredLocale !== currentLocale) {
                            var locales = {{ locales | dump | safe }};
                            if (locales.includes(preferredLocale)) {
                                var base = ('{{ pageBase or assetBase }}').replace(/\/$/, '').replace(/\/[A-Za-z0-9_-]+$/, '');
                                var to = base + '/' + preferredLocale + '/';
                                var localesPattern ='{{ locales | join('|') }}';
                                var m = location.pathname.match(new RegExp('/(' + localesPattern + ')/(.*)$'));
                                var rest = m && m[2]
                                    ? m[2]
                                    : '';
                                location.replace(to + rest);
                                return;
                            }
                        }
                    } catch (e) {}
                })();
                (function () {
                    var btn = document.getElementById('lang-btn');
                    var menu = document.getElementById('lang-menu');
                    var remember = document.getElementById('lang-remember-checkbox');
                    if (! btn || ! menu) 
                        return;
                    
                    // 读取记住语言状态
                    try {
                        var rememberPref = localStorage.getItem('remember-language') === 'true';
                        if (remember) 
                            remember.checked = rememberPref;
                        
                    } catch (e) {}
                    // 展开/收起菜单
                    btn.addEventListener('click', function (e) {
                        e.stopPropagation();
                        var isExpanded = btn.getAttribute('aria-expanded') === 'true';
                        btn.setAttribute('aria-expanded', ! isExpanded);
                        menu.hidden = isExpanded;
                    });
                    // 点击外部关闭菜单
                    document.addEventListener('click', function () {
                        btn.setAttribute('aria-expanded', 'false');
                        menu.hidden = true;
                    });
                    menu.addEventListener('click', function (e) {
                        e.stopPropagation();
                    });
                    // 记住语言复选框
                    if (remember) {
                        remember.addEventListener('change', function () {
                            try {
                                localStorage.setItem('remember-language', remember.checked);
                                if (remember.checked) {
                                    localStorage.setItem('preferred-locale', '{{ locale }}');
                                }
                            } catch (e) {}
                        });
                    }
                    // 点击语言选项切换语言
                    var options = menu.querySelectorAll('.lang-option');
                    options.forEach(function (opt) {
                        opt.addEventListener('click', function () {
                            var loc = opt.getAttribute('data-locale');
                            try {
                                localStorage.setItem('preferred-locale', loc);
                            } catch (e) {}
                            var base = ('{{ pageBase or assetBase }}').replace(/\/$/, '').replace(/\/[A-Za-z0-9_-]+$/, '');
                            var to = base + '/' + loc + '/';
                            var localesPattern ='{{ locales | join('|') }}';
                            var m = location.pathname.match(new RegExp('/(' + localesPattern + ')/(.*)$'));
                            var rest = m && m[2]
                                ? m[2]
                                : '';
                            location.href = to + rest;
                        });
                    });
                })();
        </script>
        {% block page_scripts %}
        {% endblock %}
    </body>
</html>
