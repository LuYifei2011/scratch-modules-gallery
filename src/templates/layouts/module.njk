{% extends "layouts/base.njk" %}
{% block title %}
    {{ module.name }} - {{ config.siteName }}
{% endblock %}
{% set canonical = '/' + locale + '/modules/' + module.slug + '/' %}
{% block meta_description %}
    {{ module.description }}
{% endblock %}
{% block meta_keywords %}<meta name="keywords" content="{{ config.keywords }}{% if module.tags.length %},{{ module.tags | join(',') }}{% endif %}"/>{% endblock %}
{% block head_extra %}
    <script type="application/ld+json">{ "@context": "https://schema.org", "@type": "SoftwareSourceCode", "name": "{{ module.name | replace('"','\"') }}",
        "description": "{{ module.description | replace('"','\"') }} ", "programmingLanguage": "Scratch",
        {# 合并 tags 与 keywords，确保都是数组 #}
        {% set tags_str = module.tags | join(',') %} "keywords": "{{ tags_str }}", "url": "{{ config.baseUrl }} /{{ locale }}
        /modules/{{ module.slug }}/" }</script>
{% endblock %}
{% block content %}
    <article class="module-detail">
        <h1>{{ module.name }}</h1>
        <p>{{ module.description }}</p>
        <p class="tags">
            {% for t in module.tags %}
                <span class="tag">{{ t }}</span>
            {% endfor %}
        </p>
        {% if module.contributors.length %}
            <p class="contributors">{{ t.module.contributors }}:
                {% for c in module.contributors %}
                    <span class="contributor">
                        {% if c.url %}
                            <a href="{{ c.url }}" target="_blank" rel="noopener">{{ c.name }}</a>
                        {% else %}
                            {{ c.name }}
                        {% endif %}
                    </span>
                {% endfor %}
            </p>
        {% endif %}
        <section>
            <h2>{{ t.module.scripts }}</h2>
            <div class="sb-style-switcher" style="margin:0 0 1rem;">
                <label for="sb-style">{{ t.module.renderStyle }}
                </label>
                <select id="sb-style">
                    <option value="scratch3" selected>Scratch 3</option>
                    <option value="scratch3-high-contrast">Scratch 3 ({{ t.module.highContrast }})</option>
                    <option value="scratch2">Scratch 2</option>
                </select>
            </div>
            <div class="sb-translate-switcher" style="margin:0 0 1rem;">
                <label for="sb-translate">{{ t.module.translateTo }}
                </label>
                <select id="sb-translate">
                    <option value="no-translate" selected>{{ t.module.noTranslate }}</option>
                </select>
            </div>
            {% if module.scripts and module.scripts.length %}
                {% for s in module.scripts %}
                    {% if s.imported %}
                        <details class="imported-script">
                            <summary>
                                {{ t.module.importedFrom }}
                                <a href="{{ pageBase }}/modules/{{ s.fromId }}/">{{ s.fromName }}</a>
                                {% if s.fromTitle %}
                                    · {{ s.fromTitle }}
                                {% endif %}
                                {% if s.fromIndex %}
                                    (#{{ s.fromIndex }}){% endif %}
                            </summary>
                            <pre class="scratchblocks">{{ s.content | escape }}</pre>
                        </details>
                    {% else %}
                        <div class="script-block">
                            {% if s.title %}
                                <h3 class="script-title">{{ s.title }}</h3>
                            {% endif %}
                            {% if s.leadingImports %}
                                {% for imp in s.leadingImports %}
                                    <details class="imported-script">
                                        <summary>
                                            {{ t.module.importedFrom }}
                                            <a href="{{ pageBase }}/modules/{{ imp.fromId }}/">{{ imp.fromName }}</a>
                                            {% if imp.fromTitle %}
                                                · {{ imp.fromTitle }}
                                            {% endif %}
                                            {% if imp.fromIndex %}
                                                (#{{ imp.fromIndex }}){% endif %}
                                        </summary>
                                        <pre class="scratchblocks">{{ imp.content | escape }}</pre>
                                    </details>
                                {% endfor %}
                            {% endif %}
                            <pre class="scratchblocks">{{ s.content | escape }}</pre>
                        </div>
                    {% endif %}
                {% endfor %}
            {% else %}
                <pre class="scratchblocks">{{ module.script | escape }}</pre>
            {% endif %}
        </section>
        {% if module.variables.length %}
            <section>
                <h2>{{ t.module.variablesTitle }}</h2>
                <table class="variables">
                    <thead>
                        <tr>
                            <th>{{ t.module.varName }}</th>
                            <th>{{ t.module.varType }}</th>
                            <th>{{ t.module.varScope }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for v in module.variables %}
                            {% set typeMap = t.module.typeMap %}
                            {% set scopeMap = t.module.scopeMap %}
                            <tr>
                                <td>{{ v.displayName or v.name }}</td>
                                <td>{{ typeMap[v.type] or v.type }}</td>
                                <td>{{ scopeMap[v.scope] or v.scope }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </section>
        {% endif %}
        {% if module.notesHtml %}
            <section>
                <h2>{{ t.module.notes }}</h2>
                {{ module.notesHtml | safe }}
            </section>
        {% endif %}
        {% if module.hasDemo %}
            <section>
                <div style="display:flex;align-items:center;gap:1em;margin-bottom:0.83rem;margin-top:0.83rem;">
                    <h2 style="margin:0;">{{ t.module.demo }}</h2>
                    <a
                        class="tw-open-btn"
                        href="https://turbowarp.org/editor?project_url={{ (config.baseUrl + '/modules/' + module.slug + '/demo.sb3') | urlencode }}"
                        target="_blank"
                        rel="noopener"
                        style="display:inline-block;padding:0.5em
                            1em;background:#4c97ff;color:#fff;border-radius:4px;text-decoration:none;font-weight:bold;font-size:1rem;">
                        {{ t.module.openInTW }}</a>
                </div>
                <iframe
                    src="https://turbowarp.org/embed?project_url={{ (config.baseUrl + '/modules/' + module.slug + '/demo.sb3') | urlencode }}&settings-button&addons=pause,clones"
                    width="482"
                    height="412"
                    allowtransparency="true"
                    frameborder="0"
                    scrolling="no"
                    allowfullscreen
                    loading="lazy"></iframe>
            </section>
        {% endif %}
        {% if module.references.length %}
            <section>
                <h2>{{ t.module.references }}</h2>
                <ul>
                    {% for r in module.references %}
                        <li>
                            <a href="{{ r.url }}" target="_blank" rel="noopener">{{ r.title }}</a>
                            {% if r.type %}
                                <em>({{ r.type }})</em>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            </section>
        {% endif %}
    </article>
{% endblock %}
{% block page_scripts %}
    <link rel="stylesheet" href="{{ assetBase }}/module.css"/>
    <script type="module" src="{{ assetBase }}/module.js"></script>
{% endblock %}